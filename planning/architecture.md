# Lifely Architecture

> System design for Google Calendar 2025 Wrapped
>
> **Last Updated**: 2025-12-12
> **Status**: Phase 1-3 âœ… Complete | Phase 4 ğŸš§ In Progress (React UI wired, needs validation)

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              LIFELY                                          â”‚
â”‚                    "Flighty, but for your life"                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Google Calendar  â”€â”€â”€â–¶  Data Pipeline  â”€â”€â”€â–¶  Enrichment  â”€â”€â”€â–¶  Output     â”‚
â”‚                                                                              â”‚
â”‚   â€¢ Fetch events        â€¢ Normalize         â€¢ Locations      â€¢ JSON stats   â”‚
â”‚   â€¢ OAuth auth          â€¢ Friend stats      â€¢ LLM classify   â€¢ CLI display  â”‚
â”‚                         â€¢ Time stats        â€¢ Infer friends  â€¢ (UI later)   â”‚
â”‚                         â€¢ Location stats    â€¢ Activities     â”‚              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Operational Constraints

- **OpenAI rate limits**: current GPT-5 family limits are ~3 RPM, so the pipeline must pack work into fewer, larger requests.
- **LLM key safety**: production must route LLM calls via a proxy (Cloudflare Worker) so keys are never shipped to the browser.
- **Current React defaults**: `gpt-5.2` as primary model with fallbacks; location/classification are cached client-side to make reruns cheap.

## High-Level Architecture

```
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  Google Cloud   â”‚
                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                 â”‚  â”‚ Calendar  â”‚  â”‚
                                 â”‚  â”‚ API       â”‚  â”‚
                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 LIFELY                     â”‚
                    â”‚                                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚       â”‚  â”‚  Auth    â”‚  â”‚  Fetch   â”‚  â”‚ Normalizeâ”‚ â”‚       â”‚  Output  â”‚
â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  â”‚          â”‚â”€â–¶â”‚          â”‚â”€â–¶â”‚          â”‚ â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚          â”‚
â”‚ (CLI)    â”‚       â”‚  â”‚ (OAuth)  â”‚  â”‚ (Cache)  â”‚  â”‚ (Clean)  â”‚ â”‚       â”‚ (JSON)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚        â”‚                            â”‚      â”‚
                    â”‚        â–¼                            â–¼      â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                    â”‚  â”‚            STATS LAYER                â”‚â”‚
                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚â”‚
                    â”‚  â”‚  â”‚ Friend   â”‚  â”‚  Time    â”‚           â”‚â”‚
                    â”‚  â”‚  â”‚ Stats    â”‚  â”‚  Stats   â”‚           â”‚â”‚
                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                    â”‚                      â”‚                     â”‚
                    â”‚                      â–¼                     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                    â”‚  â”‚       LLM ENRICHMENT (Async)          â”‚â”‚
                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚â”‚
                    â”‚  â”‚  â”‚ Location â”‚  â”‚  Event   â”‚           â”‚â”‚
                    â”‚  â”‚  â”‚ Extract  â”‚  â”‚ Classify â”‚           â”‚â”‚
                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚â”‚
                    â”‚  â”‚       â”‚              â”‚                 â”‚â”‚
                    â”‚  â”‚       â–¼              â–¼                 â”‚â”‚
                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚â”‚
                    â”‚  â”‚  â”‚ Inferred â”‚  â”‚ Activity â”‚           â”‚â”‚
                    â”‚  â”‚  â”‚ Friends  â”‚  â”‚  Stats   â”‚           â”‚â”‚
                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                    â”‚                                            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚     OpenAI      â”‚
                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                 â”‚  â”‚  gpt-5.2  â”‚  â”‚
                                 â”‚  â”‚ Responses â”‚  â”‚
                                 â”‚  â”‚    API    â”‚  â”‚
                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATA FLOW PIPELINE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 PHASE 1 âœ…                          PHASE 2 âœ…
 â•â•â•â•â•â•â•â•â•â•                          â•â•â•â•â•â•â•â•â•â•

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Calendarâ”‚    â”‚  Raw    â”‚    â”‚Normalizedâ”‚   â”‚ Email   â”‚    â”‚ Final   â”‚
 â”‚  API    â”‚â”€â”€â”€â–¶â”‚ Events  â”‚â”€â”€â”€â–¶â”‚ Events  â”‚â”€â”€â”€â–¶â”‚ Friends â”‚â”€â”€â”€â–¶â”‚ Stats   â”‚
 â”‚         â”‚    â”‚ (JSON)  â”‚    â”‚         â”‚    â”‚         â”‚    â”‚ (JSON)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                              â”‚              â–²
                    â–¼                              â–¼              â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
               â”‚  Cache  â”‚                   â”‚ Time    â”‚         â”‚
               â”‚  (disk) â”‚                   â”‚ Stats   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                                                 â”‚
 LLM ENRICHMENT (Async Parallel Batching)                       â”‚
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                       â”‚
                                                                 â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
               â”‚ Locationâ”‚    â”‚ venue   â”‚                       â”‚
               â”‚  Stringsâ”‚â”€â”€â”€â–¶â”‚ neighborâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
               â”‚ (dedup) â”‚    â”‚ cuisine â”‚                       â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
                                                                 â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
               â”‚  Solo   â”‚    â”‚ Classifyâ”‚    â”‚ Inferredâ”‚        â”‚
               â”‚ Events  â”‚â”€â”€â”€â–¶â”‚ SOCIAL/ â”‚â”€â”€â”€â–¶â”‚ Friends â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”¤
               â”‚         â”‚    â”‚ ACTIVITYâ”‚    â”‚         â”‚        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                                   â”‚                             â”‚
                                   â–¼                             â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
                              â”‚Activity â”‚                       â”‚
                              â”‚Category â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ Stats   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Module Breakdown

### Core Modules (Phase 1) âœ…

| Module | File | Responsibility | Input | Output |
|--------|------|----------------|-------|--------|
| **Auth** | `auth.py` | OAuth 2.0 flow, token management | `credentials.json` | Authenticated API service |
| **Fetch** | `fetch.py` | Retrieve calendar events, pagination, caching | API service, year | `list[dict]` raw events |
| **Models** | `models.py` | Data structures for all entities | - | Dataclasses |
| **Normalize** | `normalize.py` | Clean raw API data, timezone handling | Raw events | `list[NormalizedEvent]` |
| **Stats** | `stats.py` | Aggregate by friend, time, location | Normalized events | `FriendStats`, `TimeStats`, `LocationStats` |
| **CLI** | `cli.py` | User interface, orchestration | CLI args | Terminal output, JSON file |

### Enrichment Module (Phase 2) âœ…

| Module | File | Responsibility | Input | Output |
|--------|------|----------------|-------|--------|
| **LLM Enrich** | `llm_enrich.py` | All LLM enrichment (async batching) | Events | See below |
| **Places Fallback** | `places.py` | Resolve Google Maps links via Places API (if key present) | Maps URL/text | `LocationEnrichment` |

**`llm_enrich.py` Functions:**

| Function | Purpose | Output |
|----------|---------|--------|
| `enrich_all_events_sync()` | Extract location data from events | `dict[str, LocationEnrichment]` |
| `classify_solo_events_sync()` | Classify events as SOCIAL/ACTIVITY/OTHER | `(list[InferredFriend], dict[str, ActivityCategoryStats])` |
| `suggest_merges()` | Link inferred names to email friends | `list[MergeSuggestion]` |
| `apply_enrichments_to_friend_stats()` | Add location data to friend events | `list[FriendStats]` (enriched) |

> **Note**: GPT-5.2 (default) handles most enrichment; Places API is used opportunistically for Google Maps links when `GOOGLE_MAPS_API_KEY` is set.

---

## Data Models

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            DATA MODELS                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 RAW (from API)              NORMALIZED (Phase 1)           ENRICHED (Phase 2)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ API Event   â”‚            â”‚ NormalizedEvent â”‚           â”‚ NormalizedEvent â”‚
 â”‚ (dict)      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ + PlaceDetails  â”‚
 â”‚             â”‚            â”‚ â€¢ id            â”‚           â”‚                 â”‚
 â”‚ â€¢ id        â”‚            â”‚ â€¢ summary       â”‚           â”‚ â€¢ venue_name    â”‚
 â”‚ â€¢ summary   â”‚            â”‚ â€¢ start/end     â”‚           â”‚ â€¢ neighborhood  â”‚
 â”‚ â€¢ start     â”‚            â”‚ â€¢ duration_mins â”‚           â”‚ â€¢ cuisine       â”‚
 â”‚ â€¢ end       â”‚            â”‚ â€¢ attendees[]   â”‚           â”‚                 â”‚
 â”‚ â€¢ attendees â”‚            â”‚ â€¢ location_raw  â”‚           â”‚                 â”‚
 â”‚ â€¢ location  â”‚            â”‚                 â”‚           â”‚                 â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                 â”‚
                    â–¼                                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ NormalizedAttendeeâ”‚             â”‚ FriendEvent     â”‚
          â”‚                 â”‚               â”‚                 â”‚
          â”‚ â€¢ email         â”‚               â”‚ â€¢ id            â”‚
          â”‚ â€¢ display_name  â”‚               â”‚ â€¢ summary       â”‚
          â”‚ â€¢ is_self       â”‚               â”‚ â€¢ date          â”‚
          â”‚ â€¢ response_statusâ”‚              â”‚ â€¢ hours         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â€¢ location_raw  â”‚
                                            â”‚ â€¢ venue_name    â”‚
                                            â”‚ â€¢ neighborhood  â”‚
                                            â”‚ â€¢ cuisine       â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


 AGGREGATED STATS                           INFERRED (LLM)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                           â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ FriendStats     â”‚                        â”‚ InferredFriend  â”‚
 â”‚ (email-based)   â”‚                        â”‚ (name-based)    â”‚
 â”‚                 â”‚                        â”‚                 â”‚
 â”‚ â€¢ email         â”‚                        â”‚ â€¢ name          â”‚
 â”‚ â€¢ display_name  â”‚â—„â”€â”€â”€â”€ merge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ normalized    â”‚
 â”‚ â€¢ event_count   â”‚      suggestion        â”‚ â€¢ event_count   â”‚
 â”‚ â€¢ total_hours   â”‚                        â”‚ â€¢ total_hours   â”‚
 â”‚ â€¢ events[]      â”‚                        â”‚ â€¢ events[]      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚ â€¢ linked_email  â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ TimeStats       â”‚                        â”‚ MergeSuggestion â”‚
 â”‚                 â”‚                        â”‚                 â”‚
 â”‚ â€¢ total_events  â”‚                        â”‚ â€¢ inferred_name â”‚
 â”‚ â€¢ total_hours   â”‚                        â”‚ â€¢ suggested_emailâ”‚
 â”‚ â€¢ per_month     â”‚                        â”‚ â€¢ confidence    â”‚
 â”‚ â€¢ per_weekday   â”‚                        â”‚ â€¢ reason        â”‚
 â”‚ â€¢ busiest_day   â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


 ACTIVITY ANALYSIS (LLM)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ ActivityEvent   â”‚                        â”‚ ActivityCategoryStats   â”‚
 â”‚                 â”‚                        â”‚                         â”‚
 â”‚ â€¢ id            â”‚                        â”‚ â€¢ category (fitness,    â”‚
 â”‚ â€¢ summary       â”‚                        â”‚   wellness, health,     â”‚
 â”‚ â€¢ date          â”‚â”€â”€â”€â”€ aggregate â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   personal_care,        â”‚
 â”‚ â€¢ hours         â”‚                        â”‚   learning, entertain)  â”‚
 â”‚ â€¢ category      â”‚                        â”‚ â€¢ event_count           â”‚
 â”‚ â€¢ activity_type â”‚                        â”‚ â€¢ total_hours           â”‚
 â”‚ â€¢ venue_name    â”‚                        â”‚ â€¢ top_venues[]          â”‚
 â”‚                 â”‚                        â”‚ â€¢ top_activities[]      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 Categories:
 â€¢ fitness      - gym, yoga, climbing, running, pilates, cycling
 â€¢ wellness     - massage, spa, meditation, acupuncture
 â€¢ health       - doctor, dentist, therapy, physical therapy
 â€¢ personal_care - haircut, nails, facial, waxing
 â€¢ learning     - class, lesson, workshop, tutoring
 â€¢ entertainment - concert, show, movie, museum, game


 LOCATION (Phase 2)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ PlaceDetails    â”‚      â”‚ VenueStats      â”‚      â”‚ NeighborhoodStatsâ”‚
 â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚
 â”‚ â€¢ place_id      â”‚      â”‚ â€¢ place_id      â”‚      â”‚ â€¢ name          â”‚
 â”‚ â€¢ name          â”‚      â”‚ â€¢ name          â”‚      â”‚ â€¢ city          â”‚
 â”‚ â€¢ address       â”‚      â”‚ â€¢ neighborhood  â”‚      â”‚ â€¢ event_count   â”‚
 â”‚ â€¢ neighborhood  â”‚      â”‚ â€¢ cuisine       â”‚      â”‚ â€¢ total_hours   â”‚
 â”‚ â€¢ city/state    â”‚      â”‚ â€¢ visit_count   â”‚      â”‚ â€¢ top_venues    â”‚
 â”‚ â€¢ lat/lng       â”‚      â”‚ â€¢ total_hours   â”‚      â”‚ â€¢ cuisines      â”‚
 â”‚ â€¢ types[]       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚ â€¢ primary_type  â”‚
 â”‚ â€¢ price_level   â”‚
 â”‚ â€¢ rating        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## External Dependencies

### APIs Required

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EXTERNAL DEPENDENCIES                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           GOOGLE CLOUD                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service         â”‚ Purpose           â”‚ Auth                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Calendar API    â”‚ Fetch events      â”‚ OAuth 2.0 (credentials.json)          â”‚
â”‚                 â”‚                   â”‚ Scope: calendar.readonly              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            OPENAI                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service         â”‚ Purpose           â”‚ Auth                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPT-5.2         â”‚ All enrichment:   â”‚ API Key (OPENAI_API_KEY)              â”‚
â”‚ Responses API   â”‚ â€¢ Location extractâ”‚ ~$0.05 per run                        â”‚
â”‚                 â”‚ â€¢ SOCIAL â†’ names  â”‚ Async batched: 50 events/request      â”‚
â”‚                 â”‚ â€¢ ACTIVITY â†’ type â”‚ 2 concurrent batches max              â”‚
â”‚                 â”‚ â€¢ Venue from titleâ”‚ Retry with exponential backoff        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

> **Note**: Google Places API is used only when a Google Maps URL is present and a key is configured; everything else still relies on LLM extraction.
```

### Environment Variables

```bash
# credentials/credentials.json - OAuth client (downloaded from GCP)
# credentials/token.json       - Auto-generated after first auth

# Required for enrichment
OPENAI_API_KEY=your_openai_api_key
```

### Python Dependencies

```
Phase 1 (Core):
â”œâ”€â”€ google-api-python-client  # Calendar API client
â”œâ”€â”€ google-auth-oauthlib      # OAuth flow
â”œâ”€â”€ google-auth-httplib2      # HTTP transport
â”œâ”€â”€ python-dateutil           # Date parsing
â””â”€â”€ rich                      # CLI formatting

Phase 2 (Enrichment):
â””â”€â”€ openai                    # GPT-5 API client (async support)
```

---

## File Structure

```
lifely/
â”œâ”€â”€ planning/
â”‚   â”œâ”€â”€ concept.md              # Original vision doc
â”‚   â”œâ”€â”€ phase1-plan.md          # Phase 1 implementation details
â”‚   â”œâ”€â”€ phase2-event-summaries.md  # Phase 2 implementation details
â”‚   â”œâ”€â”€ future-phases.md        # Phases 3-5 roadmap
â”‚   â”œâ”€â”€ architecture.md         # This document
â”‚   â””â”€â”€ status.md               # Current project status
â”‚
â”œâ”€â”€ credentials/                # OAuth credentials (gitignored)
â”‚   â”œâ”€â”€ credentials.json        # Downloaded from GCP
â”‚   â””â”€â”€ token.json              # Auto-generated
â”‚
â”œâ”€â”€ data/                       # Output data (gitignored)
â”‚   â”œâ”€â”€ raw_events_2025.json    # Cached API response
â”‚   â””â”€â”€ stats_2025.json         # Computed statistics (full output)
â”‚
â”œâ”€â”€ src/lifely/
â”‚   â”‚
â”‚   â”‚  # â•â•â•â•â•â• PHASE 1 âœ… â•â•â•â•â•â•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth.py                 # OAuth authentication
â”‚   â”œâ”€â”€ fetch.py                # Calendar API fetching
â”‚   â”œâ”€â”€ models.py               # All data models
â”‚   â”œâ”€â”€ normalize.py            # Event normalization
â”‚   â”œâ”€â”€ stats.py                # Statistics computation
â”‚   â”œâ”€â”€ cli.py                  # CLI entrypoint & display
â”‚   â”‚
â”‚   â”‚  # â•â•â•â•â•â• PHASE 2 âœ… â•â•â•â•â•â•
â”‚   â””â”€â”€ llm_enrich.py           # GPT-5 enrichment (async batching)
â”‚
â”œâ”€â”€ tests/                      # Test files
â”œâ”€â”€ pyproject.toml              # Project config
â”œâ”€â”€ .env.example                # Environment template
â””â”€â”€ README.md                   # Setup instructions
```

---

## Processing Pipeline Detail

### Step-by-Step Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PROCESSING PIPELINE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: AUTHENTICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ credentials/ â”‚     â”‚   OAuth      â”‚     â”‚  Authenticatedâ”‚
â”‚ credentials  â”‚â”€â”€â”€â”€â–¶â”‚   Flow       â”‚â”€â”€â”€â”€â–¶â”‚  Service      â”‚
â”‚ .json        â”‚     â”‚ (browser)    â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ credentials/ â”‚
                     â”‚ token.json   â”‚
                     â”‚ (cached)     â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 2: FETCH EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Calendar    â”‚     â”‚  Paginate    â”‚     â”‚ raw_events_  â”‚
â”‚  API         â”‚â”€â”€â”€â”€â–¶â”‚  (2500/page) â”‚â”€â”€â”€â”€â–¶â”‚ 2025.json    â”‚
â”‚              â”‚     â”‚              â”‚     â”‚ (cached)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Parameters:
       â”‚ â€¢ timeMin: 2025-01-01
       â”‚ â€¢ timeMax: 2026-01-01
       â”‚ â€¢ singleEvents: true
       â”‚ â€¢ orderBy: startTime
       â–¼


STEP 3: NORMALIZE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Raw Events  â”‚     â”‚  For each:   â”‚     â”‚ Normalized   â”‚
â”‚  (dict[])    â”‚â”€â”€â”€â”€â–¶â”‚  â€¢ Parse TZ  â”‚â”€â”€â”€â”€â–¶â”‚ Events       â”‚
â”‚              â”‚     â”‚  â€¢ Calc dur  â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â€¢ Clean att â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚  â€¢ Detect selfâ”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 4: COMPUTE STATS (Email-based)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Normalized   â”‚     â”‚  Group by:   â”‚     â”‚ FriendStats  â”‚
â”‚ Events       â”‚â”€â”€â”€â”€â–¶â”‚  â€¢ Attendee  â”‚â”€â”€â”€â”€â–¶â”‚ (email-based)â”‚
â”‚              â”‚     â”‚  â€¢ Filter sysâ”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â€¢ Sum hours â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
       â”‚                                         â”‚
       â–¼                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚ TimeStats    â”‚                                 â”‚
â”‚ â€¢ per month  â”‚                                 â”‚
â”‚ â€¢ per weekdayâ”‚                                 â”‚
â”‚ â€¢ busiest dayâ”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
                                                 â”‚

STEP 5a: LOCATION ENRICHMENT (Async Parallel)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input: Unique location strings from all events                          â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Processing:                                         â”‚
â”‚  â”‚   OpenAI     â”‚    â€¢ Async parallel batches (2 concurrent)             â”‚
â”‚  â”‚GPT-5.2        â”‚    â€¢ 50 events per batch                               â”‚
â”‚  â”‚   Responses  â”‚    â€¢ Retry with exponential backoff (5s, 10s, 20s...)  â”‚
â”‚  â”‚   API        â”‚    â€¢ Deduplication by location string                  â”‚
â”‚  â”‚              â”‚                                                        â”‚
â”‚  â”‚  (~$0.05)    â”‚    Output: venue_name, neighborhood, city, cuisine     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 5b: SOLO EVENT CLASSIFICATION (Async Parallel)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input: Events without attendees (solo events)                           â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Classification:                                     â”‚
â”‚  â”‚   OpenAI     â”‚    â€¢ SOCIAL â†’ extract names ["Masha", "John"]          â”‚
â”‚  â”‚GPT-5.2        â”‚    â€¢ ACTIVITY â†’ category, activity_type, venue         â”‚
â”‚  â”‚   Responses  â”‚    â€¢ OTHER â†’ skip                                      â”‚
â”‚  â”‚   API        â”‚                                                        â”‚
â”‚  â”‚              â”‚    Venue extraction from summary:                      â”‚
â”‚  â”‚  (~$0.05)    â”‚    â€¢ "Yoga @ Vital" â†’ venue: "Vital"                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â€¢ "Climbing at Brooklyn Boulders" â†’ venue: "BB"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 5c: AGGREGATE RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Apply enrichments & aggregate:                          â”‚
              â”‚                                                          â”‚
              â”‚  â€¢ FriendStats.events â†’ venue_name, neighborhood, etc.  â”‚
              â”‚  â€¢ SOCIAL events â†’ aggregate into InferredFriends        â”‚
              â”‚  â€¢ ACTIVITY events â†’ aggregate into ActivityCategoryStatsâ”‚
              â”‚  â€¢ Venue priority: classification > location enrichment  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 5d: MERGE SUGGESTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inferred     â”‚     â”‚  Match:      â”‚     â”‚ Merge        â”‚
â”‚ Friends      â”‚â”€â”€â”€â”€â–¶â”‚  â€¢ name in   â”‚â”€â”€â”€â”€â–¶â”‚ Suggestions  â”‚
â”‚              â”‚     â”‚    email     â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 6: OUTPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ All Stats    â”‚     â”‚  Serialize   â”‚     â”‚ stats_2025   â”‚
â”‚              â”‚â”€â”€â”€â”€â–¶â”‚  to JSON     â”‚â”€â”€â”€â”€â–¶â”‚ .json        â”‚
â”‚              â”‚     â”‚              â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI Display  â”‚
â”‚ (rich/wrappedâ”‚
â”‚  style)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Output Schema

### Final JSON Structure (Phase 2)

```json
{
  "year": 2025,
  "generated_at": "2025-12-10T15:30:00Z",

  "time_stats": {
    "total_events": 392,
    "total_hours": 1807.9,
    "events_per_month": {"1": 37, "2": 21, ...},
    "hours_per_month": {"1": 117.3, ...},
    "events_per_weekday": {"Mon": 46, "Tue": 36, ...},
    "busiest_day": ["2025-06-14", 12, 152.4]
  },

  "friend_stats": [
    {
      "email": "friend@example.com",
      "display_name": "Friend Name",
      "event_count": 4,
      "total_hours": 8.8,
      "events": [
        {
          "id": "abc123",
          "summary": "Dinner",
          "date": "2025-03-15",
          "hours": 2.5,
          "location_raw": "Thai Villa, Brooklyn",
          "venue_name": "Thai Villa",
          "neighborhood": "Williamsburg",
          "cuisine": "Thai"
        }
      ]
    }
  ],

  "inferred_friends": [
    {
      "name": "Masha",
      "normalized_name": "masha",
      "event_count": 3,
      "total_hours": 6.5,
      "linked_email": null,
      "events": [...]
    }
  ],

  "merge_suggestions": [
    {
      "inferred_name": "Masha",
      "suggested_email": "masha.k@gmail.com",
      "confidence": "high",
      "reason": "'Masha' matches email prefix"
    }
  ],

  "activity_stats": {
    "fitness": {
      "category": "fitness",
      "event_count": 45,
      "total_hours": 67.5,
      "top_venues": [["Vital Climbing", 15], ["Equinox", 12]],
      "top_activities": [["yoga", 20], ["climbing", 15], ["gym", 10]]
    },
    "wellness": {
      "category": "wellness",
      "event_count": 12,
      "total_hours": 18.0,
      "top_venues": [["Aire Ancient Baths", 5]],
      "top_activities": [["massage", 6], ["meditation", 4]]
    },
    "health": {...},
    "personal_care": {...},
    "learning": {...},
    "entertainment": {...}
  },

  "location_stats": {
    "top_venues": [...],
    "top_neighborhoods": [...],
    "top_cuisines": [...]
  }
}
```

---

## Phase Roadmap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE ROADMAP                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 PHASE 1 âœ…                PHASE 2 âœ…               PHASE 3 âœ…             PHASE 4 ğŸš§
 Calendar Pipeline         LLM Enrichment           Full Stats + LLM       Visual UI (React)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•        â•â•â•â•â•â•â•â•â•â•â•â•â•â•           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ â€¢ OAuth auth    â”‚      â”‚ â€¢ Location LLM  â”‚      â”‚ â€¢ Narrative gen â”‚    â”‚ â€¢ React 19 + TS â”‚
 â”‚ â€¢ Fetch events  â”‚      â”‚ â€¢ Solo classify â”‚      â”‚ â€¢ Patterns LLM  â”‚    â”‚ â€¢ Vite 7        â”‚
 â”‚ â€¢ Normalize     â”‚ â”€â”€â”€â–¶ â”‚ â€¢ Infer friends â”‚ â”€â”€â”€â–¶ â”‚ â€¢ Experiments   â”‚â”€â”€â”€â–¶â”‚ â€¢ 7 beat pages  â”‚
 â”‚ â€¢ Email friends â”‚      â”‚ â€¢ Activity statsâ”‚      â”‚ â€¢ Dynamic cats  â”‚    â”‚ â€¢ OAuth flow    â”‚
 â”‚ â€¢ Time stats    â”‚      â”‚ â€¢ Async batchingâ”‚      â”‚ â€¢ Coverage statsâ”‚    â”‚ â€¢ Horizontal    â”‚
 â”‚ â€¢ JSON output   â”‚      â”‚ â€¢ Rate limiting â”‚      â”‚                 â”‚    â”‚   scroll + snap â”‚
 â”‚ â€¢ CLI display   â”‚      â”‚ â€¢ Neighborhoods â”‚      â”‚                 â”‚    â”‚ â€¢ Glassmorphism â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 Dependencies:             Dependencies:            Dependencies:          Dependencies:
 â€¢ Calendar API           â€¢ Phase 1 complete       â€¢ Phase 2 complete     â€¢ Phase 3 complete
 â€¢ OAuth credentials      â€¢ OpenAI API key         â€¢ GPT-5 Responses API  â€¢ Tailwind CSS v4
                                                                          â€¢ Google Identity
```

---

## Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CACHING STRATEGY                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 LAYER 1: Calendar Events âœ…
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 File: data/raw_events_{year}.json
 Key: year
 TTL: Manual refresh (--no-cache flag)
 Size: ~1-5 MB typical

 LAYER 2: LLM Caching (Future Enhancement)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 Status: NOT IMPLEMENTED
 Rationale: LLM calls are cheap (~$0.10/run) and fast (~30s)
 Future: Could cache by location_raw string to reduce API calls


 Cache Flow:
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

 Calendar Request â”€â”€â”€â–¶ Check Cache â”€â”€â”€â–¶ HIT â”€â”€â”€â–¶ Return cached
                             â”‚
                             â”‚ MISS
                             â–¼
                        Call API â”€â”€â”€â–¶ Store in cache â”€â”€â”€â–¶ Return fresh

 LLM Request â”€â”€â”€â–¶ Always call API (no caching currently)
```

---

## Error Handling

| Error | Source | Handling |
|-------|--------|----------|
| OAuth expired | Calendar API | Auto-refresh token, re-auth if needed |
| Rate limited (429) | OpenAI API | âœ… Exponential backoff (5s, 10s, 20s, 40s, 80s) |
| LLM timeout | OpenAI API | âœ… Retry up to 5 times with backoff |
| Parse failure | LLM response | Log warning, skip event, continue |
| Network error | Any API | Retry 3x, then fail gracefully |
| Missing API key | OpenAI | âœ… Warn and skip enrichment gracefully |

---

## Security Considerations

| Asset | Protection |
|-------|------------|
| `credentials.json` | Gitignored, never commit |
| `token.json` | Gitignored, user-specific |
| API keys | Environment variables, never in code |
| Calendar data | Local only, gitignored |
| Friend emails | Local only, not uploaded anywhere |

---

## Performance Targets

| Operation | Target | Actual | Notes |
|-----------|--------|--------|-------|
| Full year fetch | < 30s | ~5s | âœ… Cached after first run |
| Stats computation | < 5s | < 1s | âœ… In-memory processing |
| LLM location enrichment | < 60s | ~20s | âœ… Async parallel (2 concurrent) |
| LLM solo classification | < 60s | ~15s | âœ… Async parallel (2 concurrent) |
| Total (cached calendar) | < 90s | ~40s | âœ… LLM calls every run |
| Total (fresh) | < 2min | ~45s | âœ… Including calendar fetch |

## Cost Targets

| Component | Cost | Notes |
|-----------|------|-------|
| OpenAI LLM (locations) | ~$0.05 | Per run |
| OpenAI LLM (classification) | ~$0.05 | Per run |
| **Total per run** | ~$0.10 | âœ… Achieved |
